<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鼠巴拉西｜第一屆打地鼠大戰</title>
    <link rel="icon" href="img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="reset.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="preload" href="img/boss.png" as="image">

    <!-- Rubik字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
</head>

<body>
    <div class="hamster_game_box">
        <button id="leaderboard-button">排行榜</button>
        <div id="mask_bg"></div>
        <div id="leaderboard">
            <h2>排行榜</h2>
            <ul id="leaderboard-list"></ul>
            <button id="close-leaderboard">關閉</button>
        </div>

        <div class="text_box_outer">
            <p class="text_box">時間剩餘：<span id="timer">60</span> 秒</p>
            <p class="text_box">分數：<span id="score">0</span></p>
        </div>

        <img src="img/Title04.png" alt="打地鼠遊戲" class="title">

        <div class="game_area">
            <div class="game_rules">
                <li>
                    <img src="img/chuchi.png" alt="惡魔">
                    <p>打擊惡魔鼠鼠<span data-stroke="獲得10分">+10分</span></p>
                </li>
                <li>
                    <img src="img/pinky.png" alt="天使">
                    <p>打擊天使鼠鼠<span data-stroke="扣10分">-10分</span></p>
                </li>
            </div>

            <div id="game-container">
                <!-- Holes will be generated by JavaScript -->
            </div>

            <div id="controls">
                <button id="start-button">開始遊戲</button>
                <button id="pause-button" disabled>暫停遊戲</button>
                <button id="restart-button" style="display: none;">重新開始</button>
            </div>

            <div id="end-game" class="body_mask">
                <div class="game_result">
                    <i class="foot"></i>
                    <h2>遊戲結束！</h2>
                    <p>你的分數是：<span id="final-score"></span></p>
                    <label for="username">輸入IG名稱上排行榜</label>
                    <input type="text" id="username" placeholder="IG帳號">
                    <p class="hint_text">取最高分 IG名稱記得打相同才會更新數據唷</p>
                    
                    <button id="submit-score">提交</button>
                    <button id="close-button" class="close-button">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- boss警示訊息 -->
    <div id="boss-alert" class="alert hidden">
        <p>警告！隱藏Boss鼠鼠即將來襲！<br>擊中+50分</p>
    </div>
    
    <!-- Audio elements -->
    <audio id="background-music" src="music/background_music.wav" loop preload="auto"></audio>
    <audio id="devil-sound" src="music/click.mov" preload="auto"></audio>
    <audio id="angel-sound" src="music/angel_music.aiff" preload="auto"></audio>
    <audio id="boss-music" src="music/boss_music.mp3" preload="auto" loop></audio>
    <audio id="boss-sound" src="music/boss_sound.mp3" preload="auto"></audio>

    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, query, orderByChild } 
        from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8hmdBjUcSDaRsQmlixinjKavqXrmu7OQ",
            authDomain: "shubalaxi-game.firebaseapp.com",
            databaseURL: "https://shubalaxi-game-default-rtdb.firebaseio.com",
            projectId: "shubalaxi-game",
            storageBucket: "shubalaxi-game.firebasestorage.app",
            messagingSenderId: "1063612342277",
            appId: "1:1063612342277:web:87f7a025f37cdb8270bc6c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 提交玩家分数到Firebase
        window.submitScoreToFirebase = async (username, score) => {
            const scoresRef = ref(db, `leaderboard/${username}`);
            try {
                // 尝试先获取现有数据
                const snapshot = await get(scoresRef);
                const currentData = snapshot.val();

                // 判断是否需要更新分数
                if (currentData && currentData.score >= score) {
                    console.log(`New score (${score}) is not higher than the current score (${currentData.score})`);
                    alert("新分數未超過目前最高分，未更新！");
                    return;
                }

                // 更新分数（首次或新分数更高时）
                await set(scoresRef, {
                    name: username,
                    score: score,
                    timestamp: Date.now(),
                });

                console.log(`Score updated for ${username}`);
            } catch (error) {
                console.error("Error submitting score:", error);
                alert("提交分数时发生错误，请稍后再试");
            }
        };

        // 获取排行榜数据并显示
        window.fetchLeaderboardData = (callback) => {
            const scoresRef = ref(db, 'leaderboard');
            onValue(scoresRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    callback([]);
                    return;
                }

                // 将对象转为数组并排序
                const scoresArray = Object.keys(data).map((key) => ({
                    name: key,
                    score: data[key].score,
                    timestamp: data[key].timestamp
                })).sort((a, b) => b.score - a.score); // 按分数降序排序

                callback(scoresArray);
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
                callback([]);
            });
        };
    </script>

    <script>
        // 初始化游戏状态
        const GameState = {
            score: 0,
            timeLeft: 60,
            isPlaying: false,
            isPaused: false
        };

        const elements = {
            timer: document.getElementById('timer'),
            score: document.getElementById('score'),
            startButton: document.getElementById('start-button'),
            pauseButton: document.getElementById('pause-button'),
            restartButton: document.getElementById('restart-button'),
            endGameDisplay: document.getElementById('end-game'),
            finalScore: document.getElementById('final-score'),
            gameContainer: document.getElementById('game-container'),
            leaderboard: document.getElementById('leaderboard'),
            leaderboardButton: document.getElementById('leaderboard-button'),
            closeLeaderboard: document.getElementById('close-leaderboard'),
            submitScoreButton: document.getElementById('submit-score'),
            closeButton: document.getElementById('close-button'),
            backgroundMusic: document.getElementById('background-music'),
            devilSound: document.getElementById('devil-sound'),
            angelSound: document.getElementById('angel-sound')
        };

        // 初始化游戏洞
        function initializeHoles() {
            elements.gameContainer.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const hole = document.createElement('div');
                hole.className = 'hole';
                hole.dataset.index = i;
                hole.innerHTML = '<div class="area_setting"></div>';
                elements.gameContainer.appendChild(hole);
            }
        }

        function startGame() {
            // 游戏开始时初始化分数、时间、UI元素
            GameState.score = 0;
            GameState.timeLeft = 60;
            GameState.isPlaying = true;
            GameState.isPaused = false;

            // 让背景音乐播放
            elements.backgroundMusic.currentTime = 0;
            elements.backgroundMusic.play();
            elements.score.textContent = GameState.score;
            elements.timer.textContent = GameState.timeLeft;

            // 显示暂停按钮并隐藏开始按钮
            elements.startButton.style.display = 'none';
            elements.pauseButton.style.display = 'block';
            elements.pauseButton.disabled = false;
            
            // 设置普通鼠标的出现计时器
            GameState.hamsterInterval = setInterval(() => showHamster('normal'), 600);

            setTimeout(() => {
                if (GameState.isPlaying) startBossMode(); // Boss模式固定30秒触发
            }, 30000); // Boss模式在30秒后触发

            // 设置游戏计时器
            const timerInterval = setInterval(() => {
                if (!GameState.isPaused) {
                    GameState.timeLeft--;
                    elements.timer.textContent = GameState.timeLeft;
                    if (GameState.timeLeft <= 0) {
                        clearInterval(GameState.hamsterInterval);
                        clearInterval(timerInterval);
                        endGame();
                    }
                }
            }, 1000);
        }

        function showHamster(type) {
            const hole = randomHole();
            const hamster = document.createElement('img');
            hamster.src = type === 'boss' ? 'img/boss.png' : (Math.random() < 0.5 ? 'img/pinky.png' : 'img/chuchi.png');
            hamster.classList.add('hamster', type === 'boss' ? 'boss' : 'normal');
            hole.appendChild(hamster);

            hamster.addEventListener('click', () => {
                if (type === 'boss') {
                    GameState.score += 50;
                    playCachedAudio('music/boss_sound.mp3');
                } else if (hamster.src.includes('pinky')) {
                    GameState.score -= 10;
                    playCachedAudio('music/angel_music.aiff');
                } else {
                    GameState.score += 10;
                    playCachedAudio('music/click.mov');
                }
                elements.score.textContent = GameState.score;
                hamster.remove();
            });

            setTimeout(() => hamster.remove(), 1200);
        }

        function startBossMode() {
            clearInterval(GameState.hamsterInterval); // 停止普通鼠鼠的生成

            elements.backgroundMusic.pause(); // 暂停普通背景音乐
            playCachedAudio('music/boss_music.mp3'); // 播放Boss背景音乐

            const bossInterval = setInterval(() => {
                showHamster('boss'); // 生成Boss鼠鼠
            }, 200);

            setTimeout(() => {
                clearInterval(bossInterval); // 停止Boss生成
                elements.backgroundMusic.play(); // 恢复普通背景音乐
                GameState.hamsterInterval = setInterval(() => showHamster('normal'), 600); // 恢复普通鼠鼠生成
            }, 15000); // Boss模式持续15秒
        }

        function pauseGame() {
            GameState.isPaused = !GameState.isPaused;
            elements.pauseButton.textContent = GameState.isPaused ? "繼續遊戲" : "暫停遊戲";
            if (GameState.isPaused) {
                elements.backgroundMusic.pause();
            } else {
                elements.backgroundMusic.play();
            }
        }

        function endGame() {
            GameState.isPlaying = false;
            elements.backgroundMusic.pause();
            elements.finalScore.textContent = GameState.score;
            elements.endGameDisplay.style.display = 'block';
        }

        function randomHole() {
            const holes = document.querySelectorAll('.hole');
            return holes[Math.floor(Math.random() * holes.length)];
        }

        // 按钮事件监听器
        elements.startButton.addEventListener('click', startGame);
        elements.pauseButton.addEventListener('click', pauseGame);
        elements.restartButton.addEventListener('click', startGame);

        // 初始化游戏洞
        initializeHoles();
    </script>
</body>
</html>
