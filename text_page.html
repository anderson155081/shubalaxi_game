<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鼠巴拉西｜第一屆打地鼠大戰</title>
    <link rel="icon" href="logo.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="reset.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Firebase CDN -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8hmdBjUcSDaRsQmlixinjKavqXrmu7OQ",
            authDomain: "shubalaxi-game.firebaseapp.com",
            databaseURL: "https://shubalaxi-game-default-rtdb.firebaseio.com",
            projectId: "shubalaxi-game",
            storageBucket: "shubalaxi-game.firebasestorage.app",
            messagingSenderId: "1063612342277",
            appId: "1:1063612342277:web:87f7a025f37cdb8270bc6c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Firebase Functions
        function submitScoreToFirebase(username, score) {
            const scoresRef = ref(db, 'leaderboard');
            const newScoreRef = push(scoresRef);
            set(newScoreRef, {
                name: username,
                score: score,
                timestamp: Date.now()
            });
        }

        function fetchLeaderboardData(callback) {
            const scoresRef = ref(db, 'leaderboard');
            onValue(scoresRef, (snapshot) => {
                const data = snapshot.val();
                const leaderboardArray = data ? Object.values(data) : [];
                callback(leaderboardArray);
            });
        }
    </script>
</head>

<body>
    <div class="hamster_game_box">
        <!-- 排行榜按鈕 -->
        <button id="leaderboard-button" onclick="toggleLeaderboard()">排行榜</button>

        <!-- 排行榜彈出視窗 -->
        <div id="leaderboard">
            <h2>排行榜</h2>
            <ul id="leaderboard-list">
             
            </ul>
            <button id="close-leaderboard" onclick="toggleLeaderboard()">關閉</button>
        </div>
        <div class="text_box_outer">
            <p class="text_box">時間剩餘：<span id="timer">30</span> 秒</p>
            <p class="text_box">分數：<span id="score">0</span></p>
        </div>
       <img src="title3.png" alt="打地鼠遊戲" class="title">

        <div class="game_area">
            <div class="game_rules">
                <li>
                    <img src="chuchi.png" alt="惡魔">
                    <p>打擊惡魔鼠鼠<span data-stroke="獲得10分">獲得10分</span></p>
                </li>
                <li>
                    <img src="pinky.png" alt="天使">
                    <p>打擊天使鼠鼠則<span data-stroke="扣10分">扣10分</span></p>
                </li>
            </div>
            <!-- 遊戲區域和控制按鈕 -->
            <div id="game-container">
                <!-- 9個洞口 -->
                <div class="hole" data-index="1">
                    <div class="area_setting"></div>
                </div>
                <div class="hole" data-index="2"><div class="area_setting"></div></div>
                <div class="hole" data-index="3"><div class="area_setting"></div></div>
                <div class="hole" data-index="4"><div class="area_setting"></div></div>
                <div class="hole" data-index="5"><div class="area_setting"></div></div>
                <div class="hole" data-index="6"><div class="area_setting"></div></div>
                <div class="hole" data-index="7"><div class="area_setting"></div></div>
                <div class="hole" data-index="8"><div class="area_setting"></div></div>
                <div class="hole" data-index="9"><div class="area_setting"></div></div>
            </div>

            <div id="controls">
                <button id="start-button" onclick="startGame()">開始遊戲</button>
                <button id="pause-button" onclick="pauseGame()" disabled>暫停遊戲</button>
                <button id="restart-button" onclick="restartGame()" style="display: none;">重新開始</button>
            </div>

            <div id="end-game" class="body_mask">
                <div class="game_result">
                    <i class="foot"></i>
                    <h2>遊戲結束！</h2>
                    <p>你的分數是：<span id="final-score"></span></p>
                    <label for="username">輸入名字上排行榜：</label>
                    <input type="text" id="username" placeholder="你的名字">
                    <button onclick="submitScore()">提交</button>
                    <button id="close-button" class="close-button">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="background-music" src="background_music.wav" loop></audio>
    <audio id="devil-sound" src="click.mp3"></audio>
    <audio id="angel-sound" src="angel_music.aiff"></audio>
    <script>
        let score = 0; // 記錄分數
        let timeLeft = 30; // 倒數計時器 從30秒開始
        let timer; // 控制計時與循環的變數
        let gameInterval; // 控制遊戲的主邏輯
        let isPaused = false; // 控制遊戲暫停

        const holes = document.querySelectorAll('.hole');
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const endGameDisplay = document.getElementById('end-game');
        const finalScoreDisplay = document.getElementById('final-score');
        const startButton = document.getElementById('start-button');
        const pauseButton = document.getElementById('pause-button');
        const restartButton = document.getElementById('restart-button');

        const leaderboardData = []; // 排行榜數據

        const defaultCursor = "url('hit.png') 16 16, auto";
        const clickedCursor = "url('hit2.png') 16 16, auto";

        // 監聽整個文檔的點擊事件，切換鼠標圖片
        document.addEventListener('click', () => {
            document.body.style.cursor = clickedCursor;
            setTimeout(() => {
                document.body.style.cursor = defaultCursor;
            }, 100);
        });

        // 顯示或隱藏排行榜視窗
        function toggleLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.style.display = leaderboard.style.display === 'none' ? 'block' : 'none';
            if (leaderboard.style.display === 'block') updateLeaderboard();
        }

        // 更新排行榜內容
        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = ''; // 清空排行榜內容

            leaderboardData.sort((a, b) => b.score - a.score); // 按分數排序
            leaderboardData.slice(0, 5).forEach((entry, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${entry.name} - ${entry.score} 分`;
                leaderboardList.appendChild(li);
            });
        }

        // 遊戲結束後提交分數
        function submitScore() {
            const username = document.getElementById('username').value;
            if (username) {
                leaderboardData.push({ name: username, score: score });
                alert(`已提交分數！玩家：${username}，分數：${score}`);
                toggleLeaderboard(); // 顯示排行榜
            }
        }

        function randomTime(min, max) {
            return Math.round(Math.random() * (max - min) + min);
        }

        function randomHole() {
            const index = Math.floor(Math.random() * holes.length);
            return holes[index];
        }

        function showHamster() {
            if (isPaused) return; // 如果遊戲暫停，不顯示倉鼠

            const hole = randomHole();
            const hamsterType = Math.random() < 0.5 ? 'angel' : 'devil';
            const hamster = document.createElement('img');

            hamster.src = hamsterType === 'angel' ? 'pinky.png' : 'chuchi.png';
            hamster.classList.add('hamster', hamsterType);
            hamster.style.display = 'block';
            hole.appendChild(hamster);

            hamster.addEventListener('click', () => {
                const devilSound = document.getElementById('devil-sound');
                const angelSound = document.getElementById('angel-sound');

                if (hamsterType === 'angel') {
                    score -= 10;
                    angelSound.currentTime = 0;
                    angelSound.play();
                } else {
                    score += 10;
                    devilSound.currentTime = 0;
                    devilSound.play();
                }
                scoreDisplay.textContent = score;
                hamster.remove();
            });

            setTimeout(() => {
                hamster.style.transform = 'translateY(-70px)';
                setTimeout(() => {
                    hamster.remove();
                }, 1000);
            }, randomTime(1500, 2000));
        }

        function startGame() {
            const backgroundMusic = document.getElementById('background-music');
            backgroundMusic.volume = 0.5;
            backgroundMusic.currentTime = 0;
            backgroundMusic.play();

            isPaused = false;
            score = 0;
            timeLeft = 30;
            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft;

            endGameDisplay.style.display = 'none';
            startButton.style.display = 'none';
            pauseButton.style.display = 'block';
            pauseButton.disabled = false;
            restartButton.style.display = 'none';

            timer = setInterval(() => {
                if (!isPaused) {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) endGame();
                }
            }, 1000);

            gameInterval = setInterval(showHamster, 600);
        }

        function pauseGame() {
            isPaused = !isPaused;
            pauseButton.textContent = isPaused ? "繼續遊戲" : "暫停遊戲";

            const backgroundMusic = document.getElementById('background-music');
            if (isPaused) {
                backgroundMusic.pause();
                document.querySelectorAll('.hamster').forEach(hamster => hamster.remove());
            } else {
                backgroundMusic.play();
            }
        }

        function endGame() {
            clearInterval(timer);
            clearInterval(gameInterval);
            const backgroundMusic = document.getElementById('background-music');
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;

            document.querySelectorAll('.hamster').forEach(hamster => hamster.remove());
            finalScoreDisplay.textContent = score;
            endGameDisplay.style.display = 'block';

            pauseButton.style.display = 'none';
            restartButton.style.display = 'block';
        }

        function restartGame() {
            clearInterval(timer);
            clearInterval(gameInterval);

            score = 0;
            timeLeft = 30;
            isPaused = false;

            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft;

            endGameDisplay.style.display = 'none';
            startButton.style.display = 'none';
            pauseButton.style.display = 'block';
            pauseButton.textContent = "暫停遊戲";
            pauseButton.disabled = false;
            restartButton.style.display = 'none';

            startGame();
        }

        $(document).ready(function () {
            $("#close-button").on('click', function () {
                endGameDisplay.style.display = 'none';
            });
        });

    </script>
    

</body>

</html>