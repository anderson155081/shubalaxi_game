<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鼠巴拉西｜第一屆打地鼠大戰</title>
    <link rel="icon" href="img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="reset.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="hamster_game_box">
        <button id="leaderboard-button">排行榜</button>
        
        <div id="leaderboard">
            <h2>排行榜</h2>
            <ul id="leaderboard-list"></ul>
            <button id="close-leaderboard">關閉</button>
        </div>

        <div class="text_box_outer">
            <p class="text_box">時間剩餘：<span id="timer">30</span> 秒</p>
            <p class="text_box">分數：<span id="score">0</span></p>
        </div>

        <img src="img/title3.png" alt="打地鼠遊戲" class="title">

        <div class="game_area">
            <div class="game_rules">
                <li>
                    <img src="img/chuchi.png" alt="惡魔">
                    <p>打擊惡魔鼠鼠<span data-stroke="獲得10分">獲得10分</span></p>
                </li>
                <li>
                    <img src="img/pinky.png" alt="天使">
                    <p>打擊天使鼠鼠則<span data-stroke="扣10分">扣10分</span></p>
                </li>
            </div>

            <div id="game-container">
                <!-- Holes will be generated by JavaScript -->
            </div>

            <div id="controls">
                <button id="start-button">開始遊戲</button>
                <button id="pause-button" disabled>暫停遊戲</button>
                <button id="restart-button" style="display: none;">重新開始</button>
            </div>

            <div id="end-game" class="body_mask">
                <div class="game_result">
                    <i class="foot"></i>
                    <h2>遊戲結束！</h2>
                    <p>你的分數是：<span id="final-score"></span></p>
                    <label for="username">輸入名字上排行榜：</label>
                    <input type="text" id="username" placeholder="你的名字">
                    <button id="submit-score">提交</button>
                    <button id="close-button" class="close-button">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="background-music" src="music/background_music.wav" loop></audio>
    <audio id="devil-sound" src="music/click.mp3"></audio>
    <audio id="angel-sound" src="music/angel_music.aiff"></audio>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, query, orderByChild } 
        from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8hmdBjUcSDaRsQmlixinjKavqXrmu7OQ",
            authDomain: "shubalaxi-game.firebaseapp.com",
            databaseURL: "https://shubalaxi-game-default-rtdb.firebaseio.com",
            projectId: "shubalaxi-game",
            storageBucket: "shubalaxi-game.firebasestorage.app",
            messagingSenderId: "1063612342277",
            appId: "1:1063612342277:web:87f7a025f37cdb8270bc6c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.submitScoreToFirebase = async (username, score) => {
            const scoresRef = ref(db, `leaderboard/${username}`);
            try {
                // 嘗試先獲取現有數據
                const snapshot = await get(scoresRef);
                const currentData = snapshot.val();

                // 判斷是否需要更新分數
                if (currentData && currentData.score >= score) {
                console.log(`New score (${score}) is not higher than the current score (${currentData.score})`);
                alert("新分數未超過目前最高分，未更新！");
                return;
                }

                // 更新分數（首次或新分數更高時）
                await set(scoresRef, {
                name: username,
                score: score,
                timestamp: Date.now(),
                });

                console.log(`Score updated for ${username}`);
            } catch (error) {
                console.error("Error submitting score:", error);
                alert("提交分數時發生錯誤，請稍後再試");
            }
        };




        window.fetchLeaderboardData = (callback) => {
            const scoresRef = ref(db, 'leaderboard');
            onValue(scoresRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    callback([]);
                    return;
                }

                // 將物件轉為陣列並排序
                const scoresArray = Object.keys(data).map((key) => ({
                    name: key,
                    score: data[key].score,
                    timestamp: data[key].timestamp
                })).sort((a, b) => b.score - a.score); // 按分數降序排序

                callback(scoresArray);
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
                callback([]);
            });
        };


    </script>

    <script>
        // Game logic
        const GameState = {
            score: 0,
            timeLeft: 30,
            isPlaying: false,
            isPaused: false
        };

        // DOM Elements
        const elements = {
            timer: document.getElementById('timer'),
            score: document.getElementById('score'),
            startButton: document.getElementById('start-button'),
            pauseButton: document.getElementById('pause-button'),
            restartButton: document.getElementById('restart-button'),
            endGameDisplay: document.getElementById('end-game'),
            finalScore: document.getElementById('final-score'),
            gameContainer: document.getElementById('game-container'),
            leaderboard: document.getElementById('leaderboard'),
            leaderboardButton: document.getElementById('leaderboard-button'),
            closeLeaderboard: document.getElementById('close-leaderboard'),
            submitScoreButton: document.getElementById('submit-score'),
            closeButton: document.getElementById('close-button'),
            backgroundMusic: document.getElementById('background-music'),
            devilSound: document.getElementById('devil-sound'),
            angelSound: document.getElementById('angel-sound')
        };

        // Initialize game holes
        function initializeHoles() {
            elements.gameContainer.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const hole = document.createElement('div');
                hole.className = 'hole';
                hole.dataset.index = i;
                hole.innerHTML = '<div class="area_setting"></div>';
                elements.gameContainer.appendChild(hole);
            }
        }

        // Game functions
        function randomTime(min, max) {
            return Math.round(Math.random() * (max - min) + min);
        }

        function randomHole() {
            const holes = document.querySelectorAll('.hole');
            return holes[Math.floor(Math.random() * holes.length)];
        }

        function showHamster() {
            if (GameState.isPaused) return;

            const hole = randomHole();
            const hamsterType = Math.random() < 0.5 ? 'angel' : 'devil';
            const hamster = document.createElement('img');

            hamster.src = hamsterType === 'angel' ? 'img/pinky.png' : 'img/chuchi.png';
            hamster.classList.add('hamster', hamsterType);
            hamster.style.display = 'block';
            
            hole.appendChild(hamster);

            hamster.addEventListener('click', () => {
                if (hamsterType === 'angel') {
                    GameState.score -= 10;
                    elements.angelSound.currentTime = 0;
                    elements.angelSound.play();
                } else {
                    GameState.score += 10;
                    elements.devilSound.currentTime = 0;
                    elements.devilSound.play();
                }
                elements.score.textContent = GameState.score;
                hamster.remove();
            });

            setTimeout(() => {
                hamster.style.transform = 'translateY(-70px)';
                setTimeout(() => hamster.remove(), 1000);
            }, randomTime(1500, 2000));
        }

        // Game control functions
        function startGame() {
            GameState.score = 0;
            GameState.timeLeft = 30;
            GameState.isPlaying = true;
            GameState.isPaused = false;

            elements.backgroundMusic.volume = 0.5;
            elements.backgroundMusic.currentTime = 0;
            elements.backgroundMusic.play();

            elements.score.textContent = GameState.score;
            elements.timer.textContent = GameState.timeLeft;
            elements.endGameDisplay.style.display = 'none';
            elements.startButton.style.display = 'none';
            elements.pauseButton.style.display = 'block';
            elements.pauseButton.disabled = false;
            elements.restartButton.style.display = 'none';

            const gameInterval = setInterval(() => {
                if (!GameState.isPaused) {
                    showHamster();
                }
            }, 600);

            const timerInterval = setInterval(() => {
                if (!GameState.isPaused) {
                    GameState.timeLeft--;
                    elements.timer.textContent = GameState.timeLeft;
                    if (GameState.timeLeft <= 0) {
                        clearInterval(gameInterval);
                        clearInterval(timerInterval);
                        endGame();
                    }
                }
            }, 1000);
        }

        function pauseGame() {
            GameState.isPaused = !GameState.isPaused;
            elements.pauseButton.textContent = GameState.isPaused ? "繼續遊戲" : "暫停遊戲";

            if (GameState.isPaused) {
                elements.backgroundMusic.pause();
                document.querySelectorAll('.hamster').forEach(hamster => hamster.remove());
            } else {
                elements.backgroundMusic.play();
            }
        }

        function endGame() {
            GameState.isPlaying = false;
            elements.backgroundMusic.pause();
            elements.backgroundMusic.currentTime = 0;

            document.querySelectorAll('.hamster').forEach(hamster => hamster.remove());
            elements.finalScore.textContent = GameState.score;
            elements.endGameDisplay.style.display = 'block';
            elements.pauseButton.style.display = 'none';
            elements.restartButton.style.display = 'block';
        }

        // Event listeners
        elements.startButton.addEventListener('click', startGame);
        elements.pauseButton.addEventListener('click', pauseGame);
        elements.restartButton.addEventListener('click', startGame);
        elements.leaderboardButton.addEventListener('click', () => {
            elements.leaderboard.style.display = 
                elements.leaderboard.style.display === 'none' ? 'block' : 'none';
            if (elements.leaderboard.style.display === 'block') {
                fetchLeaderboardData((scores) => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    scores.slice(0, 5).forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.textContent = `${index + 1}. ${entry.name} - ${entry.score} 分`;
                        leaderboardList.appendChild(li);
                    });
                });
            }
        });

        elements.closeLeaderboard.addEventListener('click', () => {
            elements.leaderboard.style.display = 'none';
        });

        elements.submitScoreButton.addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            if (username) {
                await submitScoreToFirebase(username, GameState.score);
                alert(`已提交分數！玩家：${username}，分數：${GameState.score}`);
                elements.endGameDisplay.style.display = 'none';
                elements.leaderboard.style.display = 'block';
                fetchLeaderboardData((scores) => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    scores.slice(0, 5).forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.textContent = `${index + 1}. ${entry.name} - ${entry.score} 分`;
                        leaderboardList.appendChild(li);
                    });
                });
            }
        });

        elements.closeButton.addEventListener('click', () => {
            elements.endGameDisplay.style.display = 'none';
        });

        // Set up cursor
        const defaultCursor = "url('img/hit.png') 16 16, auto";
        const clickedCursor = "url('img/hit2.png') 16 16, auto";

        document.body.style.cursor = defaultCursor;
        
        document.addEventListener('click', () => {
            document.body.style.cursor = clickedCursor;
            setTimeout(() => {
                document.body.style.cursor = defaultCursor;
            }, 100);
        });

        // Initialize game
        initializeHoles();
    </script>
</body>
</html>